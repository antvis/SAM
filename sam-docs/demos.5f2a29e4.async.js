"use strict";(self.webpackChunk_antv_sam=self.webpackChunk_antv_sam||[]).push([[433],{90355:function(ve,Z,r){r.d(Z,{Hj:function(){return G},Kl:function(){return te},Oe:function(){return ee},XM:function(){return E},_$:function(){return ne},bw:function(){return j}});var R="https://www.google.com/maps/vt?lyrs=s@820&gl=cn&x={x}&y={y}&z={z}",G=R,ee="https://t{0-7}.tianditu.gov.cn/DataServer?T=cia_w&X={x}&Y={y}&L={z}&tk=b72aa81ac2b3cae941d1eb213499e15e",E="https://mdn.alipayobjects.com/huamei_qa8qxu/afts/file/A*eRf_QauRmqoAAAAAAAAAAAAADmJ7AQ/sam_onnx_example.glb",te=[{name:"A \u7A7A\u95F4",coord:[120.10533489408249,30.261061158180482],zoom:18},{name:"\u6CB9\u7F50",coord:[-96.74674229210954,35.935326263559816],zoom:15.5},{name:"\u519C\u7530",coord:[5.000138834496795,52.83911856295691],zoom:13.5},{name:"\u519C\u75302",coord:[-111.91603037093357,32.91837220530866],zoom:13},{name:"\u704C\u6E89\u519C\u7530",coord:[38.274419546979345,30.107721922396593],zoom:12.5},{name:"\u5EFA\u7B51",coord:[-75.68709358840009,45.40821167856009],zoom:18},{name:"\u5EFA\u7B512",coord:[-117.9375255130447,33.809435077864805],zoom:18.2},{name:"\u673A\u573A",coord:[-117.377,34.596],zoom:15.5},{name:"\u8349\u573A",coord:[28.725760156128445,22.24767189005027],zoom:12}],j=[{label:"\u70B9\u9009",value:"click"}],ne=[{label:"\u70B9\u9009",value:"click"},{label:"\u6846\u9009",value:"selectend"}]},67383:function(ve,Z,r){r.d(Z,{y:function(){return R}});var R="https://sam.lvisei.icu/api"},90142:function(ve,Z,r){r.d(Z,{O6:function(){return C},XG:function(){return se},rC:function(){return K}});var R=r(5574),G=r.n(R),ee=r(15009),E=r.n(ee),te=r(99289),j=r.n(te),ne=r(73945),ae=r.n(ne),N=r(28182),H=r.n(N),ie=null,I=function(w){var S=_slicedToArray(w,4),$=S[0],B=S[1],J=S[2],P=S[3];return{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[[[$,B],[$,P],[J,P],[J,B],[$,B]]]}}]}},me=function(w){return{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[w]}}]}},K=function(){return{type:"FeatureCollection",features:[]}};function se(z){var w=z.content,S=w;typeof w!="string"&&(S=JSON.stringify(w,null,2));var $=ae().format(S,{parser:"json",plugins:[H()]});return $}var C=function(w){var S=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"data-".concat(new Date().toLocaleString()),$=new Blob([se({content:JSON.stringify(w)})],{type:"application/json"}),B=document.createElement("a");B.download="".concat(S,".json"),B.href=URL.createObjectURL($),B.click()}},77328:function(ve,Z,r){r.r(Z),r.d(Z,{default:function(){return pe}});var R=r(15009),G=r.n(R),ee=r(19632),E=r.n(ee),te=r(99289),j=r.n(te),ne=r(5574),ae=r.n(ne),N=r(7539),H=r(28537),ie=r(34749),I=r(33573),me=r(75081),K=r(67294),se=r(44268),C=r(54539),z=r(96638),w=r(67383),S=r(90355),$=r(29972),B=r(6171),J=r(18073),P=r(50977),V=r(90142),de=r(29581),ce=r(63428),he=r(2302),_=r(85893),f=function(k){var b=k.value;return ce.languages.registerDocumentFormattingEditProvider("json",{provideDocumentFormattingEdits:function(m){return[{range:m.getFullModelRange(),text:(0,V.XG)({content:m.getValue()})}]}}),(0,de.Z)(function(){ce.editor.defineTheme("custome-theme",{base:"vs",inherit:!0,rules:[],colors:{"editor.background":"#fafafa","editorLineNumber.foreground":"#222222","editor.lineHighlightBackground":"#f4f4f4"}})}),(0,_.jsx)(he.ZP,{width:400,height:"calc(70vh - 56px)",language:"json",value:(0,V.XG)({content:b}),theme:"custome-theme",options:{selectOnLineNumbers:!0,tabIndex:2,tabSize:2,folding:!0,fontSize:13,mouseStyle:"text",foldingStrategy:"indentation",scrollBeyondLastLine:!1,foldingMaximumRegions:Number.MAX_SAFE_INTEGER,suggest:{showKeywords:!0}}})},A=r(5529),fe=r(13323),ye=function(k){var b=k.samInfo,o=k.setSamState,m=function(c){o(function(v){return{satelliteData:v.satelliteData.filter(function(M){return M.imageUrl!==c.image})}}),H.ZP.success("\u5220\u9664\u6210\u529F")},x=[{title:"\u5E8F\u53F7",dataIndex:"key",width:60},{title:"\u5F62\u72B6",dataIndex:"geometry",ellipsis:!0,render:function(c){return(0,_.jsx)(A.Z,{placement:"topLeft",title:c,children:c})}},{title:"\u56FE\u7247",dataIndex:"image",width:80,render:function(c){return(0,_.jsx)(A.Z,{color:"#fff",placement:"topLeft",title:(0,_.jsx)("img",{src:c,style:{width:200,height:200}}),children:(0,_.jsx)("img",{src:c,style:{width:30,height:30}})})}},{title:"\u5220\u9664",width:80,render:function(c,v){return(0,_.jsx)(ie.ZP,{type:"primary",danger:!0,size:"small",onClick:function(){return m(v)},children:"\u5220\u9664"})}}],T=b.satelliteData.map(function(y,c){var v,M=(v=y.features[0])===null||v===void 0?void 0:v.geometry;return{key:c,geometry:JSON.stringify(M),image:y.imageUrl}});return(0,_.jsx)(fe.Z,{size:"small",columns:x,dataSource:T})},ge=function(k){var b=k.samInfo,o=k.setSamState,m=(0,K.useMemo)(function(){var T=b.satelliteData.map(function(y){return y.features});return{type:"FeatureCollection",features:T.flat()}},[b.satelliteData]),x=[{key:"text",label:"\u7F16\u8F91\u5668\u5C55\u793A",children:(0,_.jsx)(f,{value:JSON.stringify(m!=null?m:(0,V.rC)(),null,2)})},{key:"table",label:"\u8868\u683C\u5C55\u793A",children:(0,_.jsx)(ye,{samInfo:b,setSamState:o})}];return(0,_.jsxs)("div",{className:"rightContainer",style:{width:b.collapsed?400:0},children:[(0,_.jsx)("div",{className:"rightContainer__collapsed",onClick:function(){return o(function(y){return{collapsed:!y.collapsed}})},children:b.collapsed?(0,_.jsx)(B.Z,{className:"rightContainer__collapsed__icon"}):(0,_.jsx)(J.Z,{className:"rightContainer__collapsed__icon"})}),b.collapsed&&(0,_.jsx)(P.Z,{style:{width:b.collapsed?400:0},items:x,tabBarExtraContent:(0,_.jsx)(ie.ZP,{size:"small",type:"primary",disabled:b.satelliteData.length<=0,onClick:function(){return(0,V.O6)(b.satelliteData)},children:"\u4E0B\u8F7D\u6570\u636E"})})]})},xe={samModel:null,currentScene:null,currentSource:null,mapClick:null,loading:!1,borderLayer:null,eventType:"click",collapsed:!0,satelliteData:[]},pe=function(){var oe=17,k=(0,z.Z)(xe),b=ae()(k,2),o=b[0],m=b[1],x=function(v){var M,O,D=S.Kl.find(function(F){return F.name===v.target.value});D&&((M=o.currentScene)===null||M===void 0||M.setCenter(D.coord)),(O=o.currentScene)===null||O===void 0||O.setZoom(D.zoom||17)},T=function(v){var M=Array.isArray(v),O=M?v:[v.lngLat.lng,v.lngLat.lat];m({mapClick:O})},y=function(){var c=j()(G()().mark(function v(){var M,O,D,F,X,Q,re,q,ue,Y,u,n,e,t,a,i,s,l,d;return G()().wrap(function(h){for(;;)switch(h.prev=h.next){case 0:return m({loading:!0}),F=(M=o.currentSource)===null||M===void 0||(O=M.tileset)===null||O===void 0?void 0:O.currentTiles,X=1/0,Q=1/0,re=-1/0,q=-1/0,F==null||F.forEach(function(p){X=Math.min(X,p.x),Q=Math.min(Q,p.y),re=Math.max(re,p.x),q=Math.max(q,p.y)}),ue=Math.ceil((D=o.currentScene)===null||D===void 0?void 0:D.getZoom()),Y=document.createElement("canvas"),Y.width=(re-X+1)*256,Y.height=(q-Q+1)*256,u=Y.getContext("2d"),n=o.samModel.mapHelper,e=[].concat(E()(n.tileToLngLat(X,q+1,ue)),E()(n.tileToLngLat(re+1,Q,ue))),F==null||F.forEach(function(p){p&&(u==null||u.drawImage(p.data,(p.x-X)*256,(p.y-Q)*256,256,256))}),o.samModel.setGeoImage(Y.toDataURL(),{extent:e,width:Y.width,height:Y.height}),t=Y.toDataURL("image/jpeg"),a=t.indexOf(","),i=t==null?void 0:t.substring(a+1),s=w.y,l=new FormData,l.append("image_path",i),h.next=24,fetch(s,{body:l,method:"post"});case 24:return h.next=26,h.sent.arrayBuffer();case 26:d=h.sent,o.samModel.setEmbedding(d),m({loading:!1}),H.ZP.success("embedding\u8BA1\u7B97\u5B8C\u6210");case 30:case"end":return h.stop()}},v)}));return function(){return c.apply(this,arguments)}}();return(0,K.useEffect)(function(){if(!(!o.mapClick||!o.samModel)){var c=[];try{var v=o.mapClick;if(o.eventType==="click"){var M=o.samModel.lngLat2ImagePixel(v);c.push({x:M[0],y:M[1],clickType:1})}else if(o.eventType==="selectend"){var O=o.samModel.lngLat2ImagePixel([v[0],v[3]]),D=o.samModel.lngLat2ImagePixel([v[2],v[1]]);c.push({x:O[0],y:O[1],clickType:2}),c.push({x:D[0],y:D[1],clickType:3})}else o.eventType==="all"&&console.log(o.samModel.image.width,o.samModel.image.height);if(c.length===0)return;console.time("predict"),o.samModel.predict(c).then(function(){var F=j()(G()().mark(function X(Q){var re,q,ue;return G()().wrap(function(u){for(;;)switch(u.prev=u.next){case 0:return console.timeEnd("predict"),u.next=3,o.samModel.exportGeoPolygon(Q,1);case 3:re=u.sent,q=o.samModel.exportImageClip(Q),ue={features:re.features,imageUrl:q.src},m(function(n){return{satelliteData:[].concat(E()(n.satelliteData),[ue])}});case 7:case"end":return u.stop()}},X)}));return function(X){return F.apply(this,arguments)}}())}catch(F){H.ZP.error("\u8BF7\u5148\u70B9\u51FB[\u751F\u6210 embedding] \u6309\u94AE")}}},[o.mapClick]),(0,K.useEffect)(function(){if(o.borderLayer){var c=o.satelliteData.map(function(M){return M.features}),v={type:"FeatureCollection",features:c.flat()};o.borderLayer.setData(v)}},[o.borderLayer,o.satelliteData]),(0,K.useEffect)(function(){var c=new N.xsS({id:"map",map:new C.Z({center:[120.10533489408249,30.261061158180482],zoom:oe,minZoom:3,style:"blank"})}),v=new N.Hw6(S.Hj,{parser:{type:"rasterTile",tileSize:256}}),M=new N.YYg({zIndex:-2}).source(v),O=new N.YYg({zIndex:-1}).source(S.Oe,{parser:{type:"rasterTile",tileSize:256,zoomOffset:0}}),D=new N.dWg({zIndex:10}).source({type:"FeatureCollection",features:[]}).shape("line").size(2).color("#f00").style({opacity:1});c.on("loaded",function(){c.addLayer(M),c.addLayer(O),c.addLayer(D),m({borderLayer:D,currentScene:c,currentSource:v}),c.on("click",T),c.on("selectend",T)})},[]),(0,K.useEffect)(function(){o.eventType==="selectend"&&o.currentScene?o.currentScene.enableBoxSelect(!1):o.currentScene&&o.currentScene.disableBoxSelect()},[o.eventType]),(0,K.useEffect)(function(){var c=new se.XU({modelUrl:S.XM});c.initModel().then(function(){m({samModel:c})})},[]),(0,_.jsxs)(_.Fragment,{children:[(0,_.jsx)(ie.ZP,{onClick:y,children:" \u751F\u6210 embedding "}),(0,_.jsx)(I.ZP.Group,{style:{margin:"15px"},onChange:x,defaultValue:"A \u7A7A\u95F4",buttonStyle:"solid",children:S.Kl.map(function(c){return(0,_.jsx)(I.ZP.Button,{value:c.name,children:c.name},c.name)})}),(0,_.jsx)(me.Z,{spinning:o.loading,tip:"embedding \u751F\u6210\u4E2D\u2026\u2026",children:(0,_.jsxs)("div",{className:"mapContainer",children:[(0,_.jsx)("div",{id:"map",className:"mapContainer__map",style:{width:"calc(100vw - ".concat(o.collapsed?400:0,"px)")},children:(0,_.jsx)(I.ZP.Group,{style:{position:"absolute",top:15,left:15,zIndex:100},onChange:function(v){m({eventType:v.target.value})},value:o.eventType,size:"small",buttonStyle:"solid",children:S.bw.map(function(c){return(0,_.jsx)(I.ZP.Button,{value:c.value,children:c.label},c.value)})})}),(0,_.jsx)(ge,{samInfo:o,setSamState:m})]})})]})}},2784:function(ve,Z,r){r.r(Z);var R=r(19632),G=r.n(R),ee=r(15009),E=r.n(ee),te=r(99289),j=r.n(te),ne=r(5574),ae=r.n(ne),N=r(64082),H=r(96638),ie=r(11693),I=r(28537),me=r(75081),K=r(33573),se=r(34749),C=r(96074),z=r(67294),w=r(29972),S=r(44268),$=r(67383),B=r(90142),J=r(90355),P=r(85893),V=ie.Z.Dragger,de="../model/sam_onnx_example.onnx",ce={imageUrl:"",samModel:null,loading:!1,clipImg:[],originImg:null,originMaskImg:[],isSelecting:!1,startPoint:{x:0,y:0},endPoint:{x:0,y:0},clipType:"click",eventPoint:[]};Z.default=function(){var he=(0,H.Z)(ce),_=ae()(he,2),f=_[0],A=_[1];(0,z.useEffect)(function(){var o=new S.e7({modelUrl:de});o.initModel().then(function(){A({samModel:o})})},[]);var fe=function(){var o=j()(E()().mark(function m(x,T){var y,c,v,M;return E()().wrap(function(D){for(;;)switch(D.prev=D.next){case 0:return y=$.y,c=new FormData,c.append("file",x),D.next=5,fetch(y,{body:c,method:"POST"});case 5:return D.next=7,D.sent.arrayBuffer();case 7:v=D.sent,f.samModel.setEmbedding(v),M=new Image,M.src=T,M.onload=function(){f.samModel.setImage(T),A({originImg:M})},A({imageUrl:T,loading:!1}),I.ZP.success("embedding\u8BA1\u7B97\u5B8C\u6210");case 14:case"end":return D.stop()}},m)}));return function(x,T){return o.apply(this,arguments)}}(),ye=function(){var o=j()(E()().mark(function m(x){var T,y;return E()().wrap(function(v){for(;;)switch(v.prev=v.next){case 0:if(T=x.file,v.prev=1,A({clipImg:[],originMaskImg:[],loading:!0}),T.status!=="done"){v.next=8;break}return v.next=6,(0,S.y3)(T.originFileObj);case 6:y=v.sent,fe(T.originFileObj,y);case 8:v.next=14;break;case 10:v.prev=10,v.t0=v.catch(1),A({loading:!1}),I.ZP.success("embedding\u8BA1\u7B97\u5931\u8D25");case 14:case"end":return v.stop()}},m,null,[[1,10]])}));return function(x){return o.apply(this,arguments)}}();(0,z.useEffect)(function(){if($.y)try{var o=new Image;o.src="../assets/demo.jpg",o.onload=function(){A({loading:!0});var m=document.createElement("canvas");m.width=o.width,m.height=o.height;var x=m.getContext("2d");x.drawImage(o,0,0),m.toBlob(function(){var T=j()(E()().mark(function y(c){return E()().wrap(function(M){for(;;)switch(M.prev=M.next){case 0:f.samModel&&fe(c,o.src);case 1:case"end":return M.stop()}},y)}));return function(y){return T.apply(this,arguments)}}(),"image/jpeg")}}catch(m){A({loading:!1}),I.ZP.success("embedding\u8BA1\u7B97\u5931\u8D25")}},[f.samModel]);var ge=function(m){if(f.clipType==="click"){var x=m.nativeEvent.target.getBoundingClientRect(),T=Math.round(m.pageX-x.left),y=Math.round(m.pageY-x.top),c=f.originImg?f.originImg.width/m.nativeEvent.target.offsetWidth:1;T*=c,y*=c,A({eventPoint:[T,y]})}},xe=function(m){if(f.clipType!=="click"){m.preventDefault();var x=m.nativeEvent.target.getBoundingClientRect(),T=Math.round(m.pageX-x.left),y=Math.round(m.pageY-x.top);A({isSelecting:!0,startPoint:{x:T,y}})}},pe=function(m){if(m.preventDefault(),f.clipType!=="click"){var x=m.nativeEvent.target.getBoundingClientRect(),T=Math.round(m.pageX-x.left),y=Math.round(m.pageY-x.top);A({endPoint:{x:T,y}})}},oe=function(m){if(f.clipType!=="click"){A({isSelecting:!1});var x=f.startPoint,T=f.endPoint,y={x:Math.min(x.x,T.x),y:Math.min(x.y,T.y),width:Math.abs(x.x-T.x),height:Math.abs(x.y-T.y)};A({endPoint:{x:0,y:0},startPoint:{x:0,y:0}});var c=f.originImg?f.originImg.width/m.nativeEvent.target.offsetWidth:1,v=f.originImg?f.originImg.height/m.nativeEvent.target.offsetHeight:1,M=[y.x*c,y.y*v],O=[y.x*c+y.width*c,y.y*v+y.height*v],D=[].concat(M,O);A({eventPoint:D})}},k=function(){A({endPoint:{x:0,y:0},startPoint:{x:0,y:0},isSelecting:!1,eventPoint:[]})},b=(0,z.useMemo)(function(){if(!f.isSelecting)return null;var o=f.startPoint,m=f.endPoint;return(0,P.jsx)("div",{style:{position:"absolute",left:o.x,top:o.y,width:m.x-o.x,height:m.y-o.y,backgroundColor:"rgba(255, 0, 255, 0.3)",border:"1px dashed red",pointerEvents:"none",zIndex:1}})},[f.isSelecting,f.startPoint,f.endPoint]);return(0,z.useEffect)(function(){if(f.samModel&&f.eventPoint.length!==0){console.log(f.clipType);var o=f.eventPoint,m;f.clipType==="click"&&(m=[{x:o[0],y:o[1],clickType:1}]),f.clipType==="selectend"&&(m=[{x:o[0],y:o[1],clickType:2},{x:o[2],y:o[3],clickType:3}]),console.log(m),f.samModel.predict(m).then(function(x){var T=f.samModel.exportImageClip(x),y=f.samModel.exportMaskImage(x);A(function(c){return{clipImg:[].concat(G()(c.clipImg),[T.src]),originMaskImg:[].concat(G()(c.originMaskImg),[y.src])}})})}},[f.eventPoint,f.samModel,f.clipType]),(0,P.jsx)(me.Z,{spinning:f.loading,tip:"embedding \u751F\u6210\u4E2D\u2026\u2026",children:(0,P.jsxs)("div",{className:"samPic",children:[(0,P.jsxs)("div",{className:"samPic__tool",children:[(0,P.jsxs)(V,{className:"samPic__upload",name:"file",multiple:!1,maxCount:1,showUploadList:!1,onChange:ye,accept:"image/*",children:[(0,P.jsx)("p",{className:"ant-upload-drag-icon",children:(0,P.jsx)(N.Z,{})}),(0,P.jsx)("p",{className:"ant-upload-hint",children:"\u70B9\u51FB\u6216\u62D6\u62FD\u4E0A\u4F20\u3002"})]}),(0,P.jsx)(K.ZP.Group,{style:{margin:"10px 0"},onChange:function(m){A({clipType:m.target.value,endPoint:{x:0,y:0},startPoint:{x:0,y:0},isSelecting:!1,eventPoint:[]})},value:f.clipType,size:"small",buttonStyle:"solid",children:J._$.map(function(o){return(0,P.jsx)(K.ZP.Button,{value:o.value,children:o.label},o.value)})}),(0,P.jsx)(se.ZP,{block:!0,size:"small",type:"primary",disabled:f.clipImg.length<=0,onClick:function(){return(0,B.O6)(f.clipImg,"clipImages")},style:{margin:"10px 0"},children:"\u4E0B\u8F7D\u6570\u636E"}),f.clipImg.length>0&&(0,P.jsx)("div",{className:"clipImgContent",children:f.clipImg.map(function(o,m){return(0,P.jsxs)("div",{children:[(0,P.jsx)("img",{src:o,style:{width:50,height:50}}),(0,P.jsx)(C.Z,{style:{margin:"8px 0"}})]},m)})})]}),(0,P.jsx)("div",{className:"samPic__preview",children:f.imageUrl&&(0,P.jsxs)("div",{style:{position:"relative"},children:[f.originMaskImg.length?f.originMaskImg.map(function(o,m){return(0,P.jsx)("img",{className:"samPic__preview__maskImg",src:o},m)}):null,(0,P.jsx)("img",{className:"samPic__preview__img",onClick:ge,onMouseDown:xe,onMouseMove:pe,onMouseUp:oe,onMouseOut:k,src:f.imageUrl,style:{cursor:f.clipType==="click"?"pointer":"crosshair"}}),f.clipType!=="click"&&b]})})]})})}},44268:function(ve,Z,r){r.d(Z,{e7:function(){return k},XU:function(){return Y},y3:function(){return ce}});var R=r(18736),G=function(n){var e=n.clicks,t=n.tensor,a=n.modelScale,i=t,s,l,d,g;if(e){var h=e.length;s=new Float32Array(2*(h+1)),l=new Float32Array(h+1);for(var p=0;p<h;p++)s[2*p]=e[p].x*a.samScale,s[2*p+1]=e[p].y*a.samScale,l[p]=e[p].clickType;s[2*h]=0,s[2*h+1]=0,l[h]=-1,d=new R.Tensor("float32",s,[1,h+1,2]),g=new R.Tensor("float32",l,[1,h+1])}var L=new R.Tensor("float32",[a.height,a.width]);if(!(d===void 0||g===void 0)){var U=new R.Tensor("float32",new Float32Array(256*256),[1,1,256,256]),W=new R.Tensor("float32",[0]);return{image_embeddings:i,point_coords:d,point_labels:g,orig_im_size:L,mask_input:U,has_mask_input:W}}},ee=r(15009),E=r.n(ee),te=r(99289),j=r.n(te),ne=r(12444),ae=r.n(ne),N=r(72004),H=r.n(N),ie=r(9783),I=r.n(ie),me=r(781),K="https://mdn.alipayobjects.com/huamei_qa8qxu/afts/file/A*eRf_QauRmqoAAAAAAAAAAAAADmJ7AQ/sam_onnx_example.glb",se=r(5574),C=r.n(se),z=r(69826),w=r(16479),S=r.n(w);function $(u){var n=document.createElement("canvas"),e=n.getContext("2d");return n.width=u.width,n.height=u.height,e==null||e.putImageData(u,0,0),n}function B(u){var n=$(u),e=new Image;return e.src=n.toDataURL(),e}function J(u,n,e,t){for(var a=new Uint8ClampedArray(u.data),i=new Uint8ClampedArray(4*e*t),s=0;s<n.length;s++)if(n[s]>0){var l=4*s;i[l+0]=a[l+0],i[l+1]=a[l+1],i[l+2]=Math.max(a[l+2],200),i[l+3]=a[l+3]}return B(new ImageData(i,e,t))}function P(u,n,e){for(var t=arguments.length>3&&arguments[3]!==void 0?arguments[3]:15,a=n,i=0,s=e,l=0,d=0;d<u.length;d++)if(u[d]>0){var g=d%n,h=Math.floor(d/n);a=Math.min(a,g),i=Math.max(i,g),s=Math.min(s,h),l=Math.max(l,h)}return[a-t,i+t,s-t,l+t]}function V(u,n,e,t,a,i){for(var s=[],l=0,d=n;d<t;d++)for(var g=u;g<e;g++){var h=d*i+g;s[l++]=a[h]>0?1:-1}return s}function de(u,n,e){var t=arguments.length>3&&arguments[3]!==void 0?arguments[3]:5,a=u.map(function(s){return{x:s[0]+n,y:s[1]+e}});if(t===0)return a;var i=S()(a,t,!0);return i}var ce=function(n){return new Promise(function(e,t){var a=new FileReader;a.readAsDataURL(n),a.onload=function(){return e(a.result)},a.onerror=function(i){return t(i)}})};function he(u,n,e){var t=P(u,n,e),a=C()(t,4),i=a[0],s=a[1],l=a[2],d=a[3],g=V(i,l,s,d,u,n),h=J(g,s-i,d-l);return B(h)}function _(u,n,e){var t=arguments.length>3&&arguments[3]!==void 0?arguments[3]:5,a=P(u,n,e),i=C()(a,4),s=i[0],l=i[1],d=i[2],g=i[3],h=V(s,d,l,g,u,n),p=l-s,L=g-d,U=z.Z().size([p,L]).smooth(!1).thresholds(2),W=U(h);return de(W[1].coordinates[0][0],s,d,t)}function f(u,n){for(var e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,t=0;t<n.length;t++)(e?n[t]<=0:n[t]>0)&&(u.data[4*t+0]=0,u.data[4*t+1]=0,u.data[4*t+2]=0,u.data[4*t+3]=0);return B(u)}function A(u,n,e,t){for(var a=P(n,e,t),i=C()(a,4),s=i[0],l=i[1],d=i[2],g=i[3],h=new Uint8ClampedArray(4*(l-s)*(g-d)).fill(0),p=0,L=d;L<g;L++)for(var U=s;U<l;U++){var W=L*e+U;n[W]>0&&(h[p*4]=u.data[W*4],h[p*4+1]=u.data[W*4+1],h[p*4+2]=u.data[W*4+2],h[p*4+3]=u.data[W*4+3]),p++}var le=new ImageData(h,l-s,g-d);return B(le)}function fe(u){var n=document.createElement("a");n.href=u.src,n.download="image",n.click()}function ye(u){var n=document.createElement("a");n.href=u.toDataURL("image/png"),n.download="image",n.click()}function ge(u){var n=document.createElement("canvas"),e=n.getContext("2d");return n.width=u.width,n.height=u.height,e==null||e.drawImage(u,0,0),e==null?void 0:e.getImageData(0,0,u.width,u.height)}var xe=function(n){var e=1024,t=n.naturalWidth,a=n.naturalHeight,i=e/Math.max(a,t);return{height:a,width:t,samScale:i}},pe=function(n,e){var t=1024,a=t/Math.max(e,n);return{height:e,width:n,samScale:a}},oe=r(18736),k=function(){function u(n){ae()(this,u),I()(this,"modelUrl",K),I()(this,"model",void 0),I()(this,"image",void 0),I()(this,"imageData",void 0),I()(this,"modelScale",void 0),I()(this,"tensor",void 0),n!=null&&n.modelUrl&&(this.modelUrl=n.modelUrl)}return H()(u,[{key:"initModel",value:function(){var n=j()(E()().mark(function t(){var a;return E()().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:return s.prev=0,s.next=3,R.InferenceSession.create(this.modelUrl);case 3:a=s.sent,this.model=a,s.next=10;break;case 7:throw s.prev=7,s.t0=s.catch(0),new Error("\u6A21\u578B\u52A0\u8F7D\u5931\u8D25");case 10:case"end":return s.stop()}},t,this,[[0,7]])}));function e(){return n.apply(this,arguments)}return e}()},{key:"setImage",value:function(){var n=j()(E()().mark(function t(a){var i=this;return E()().wrap(function(l){for(;;)switch(l.prev=l.next){case 0:typeof a=="string"?(this.image=new Image,this.image.src=a,this.image.onload=function(){i.getImageScale(i.image),i.imageData=ge(i.image)}):(this.image=a,this.getImageScale(this.image),this.imageData=ge(this.image));case 1:case"end":return l.stop()}},t,this)}));function e(t){return n.apply(this,arguments)}return e}()},{key:"setEmbedding",value:function(){var n=j()(E()().mark(function t(a){var i,s,l,d,g=arguments;return E()().wrap(function(p){for(;;)switch(p.prev=p.next){case 0:if(i=g.length>1&&g[1]!==void 0?g[1]:"float32",s=new me.Z,typeof a!="string"){p.next=6;break}p.t0=s.load(a),p.next=9;break;case 6:return p.next=8,s.parse(a);case 8:p.t0=p.sent;case 9:l=p.t0,d=new oe.Tensor(i,l.data,l.shape),this.tensor=d;case 12:case"end":return p.stop()}},t,this)}));function e(t){return n.apply(this,arguments)}return e}()},{key:"predict",value:function(){var n=j()(E()().mark(function t(a){var i,s,l;return E()().wrap(function(g){for(;;)switch(g.prev=g.next){case 0:if(g.prev=0,!(this.model===null||a===null||this.tensor===null||this.modelScale===null)){g.next=6;break}return console.log("model not loaded"),g.abrupt("return");case 6:if(i=G({clicks:a,tensor:this.tensor,modelScale:this.modelScale}),i!==void 0){g.next=9;break}return g.abrupt("return");case 9:return g.next=11,this.model.run(i);case 11:return s=g.sent,l=s[this.model.outputNames[0]],g.abrupt("return",l);case 14:g.next=20;break;case 16:return g.prev=16,g.t0=g.catch(0),console.log(g.t0),g.abrupt("return");case 20:case"end":return g.stop()}},t,this,[[0,16]])}));function e(t){return n.apply(this,arguments)}return e}()},{key:"predictByBox",value:function(){var n=j()(E()().mark(function t(a){return E()().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:return s.abrupt("return",a);case 1:case"end":return s.stop()}},t)}));function e(t){return n.apply(this,arguments)}return e}()},{key:"exportMaskImage",value:function(e){if(this.imageData!==void 0)return J(this.imageData,e.data,e.dims[3],e.dims[2])}},{key:"exportMaskClip",value:function(e){return he(e.data,e.dims[3],e.dims[2])}},{key:"exportImage",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(this.imageData!==void 0)return f(this.imageData,e.data,t)}},{key:"exportImageClip",value:function(e){if(this.imageData!==void 0)return A(this.imageData,e.data,e.dims[3],e.dims[2])}},{key:"exportVector",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5;return _(e.data,e.dims[3],e.dims[2],t)}},{key:"getImageScale",value:function(e){var t=e.width,a=e.height;this.modelScale=pe(t,a)}}]),u}(),b=r(19632),o=r.n(b),m=r(25098),x=r.n(m),T=r(28785),y=r.n(T),c=r(48374),v=r.n(c),M=r(31996),O=r.n(M),D=r(26037),F=r.n(D),X=function(){function u(){var n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:256,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"tms";ae()(this,u),I()(this,"tileSize",void 0),I()(this,"type",void 0),I()(this,"initialResolution",void 0),I()(this,"originShift",void 0),this.tileSize=n,this.type=e,this.initialResolution=2*Math.PI*6378137/this.tileSize,this.originShift=2*Math.PI*6378137/2}return H()(u,[{key:"lngLatToMeters",value:function(e,t){var a=e*this.originShift/180,i=Math.log(Math.tan((90+t)*Math.PI/360))/(Math.PI/180);return i=i*this.originShift/180,[a,i]}},{key:"metersToLngLat",value:function(e,t){var a=e/this.originShift*180,i=t/this.originShift*180;return i=180/Math.PI*(2*Math.atan(Math.exp(i*Math.PI/180))-Math.PI/2),[a,i]}},{key:"pixelsToMeters",value:function(e,t,a){var i=this.resolution(a),s=e*i-this.originShift,l=(this.type==="tms"?t:Math.pow(2,a)*256-t)*i-this.originShift;return[s,l]}},{key:"metersToPixels",value:function(e,t,a){var i=this.resolution(a),s=(e+this.originShift)/i,l=(t+this.originShift)/i;return l=this.type==="tms"?l:Math.pow(2,a)*256-l,[s,l]}},{key:"metersToTile",value:function(e,t,a){var i=this.metersToPixels(e,t,a),s=C()(i,2),l=s[0],d=s[1];return this.pixelsToTile(l,d)}},{key:"tileToMeters",value:function(e,t,a){return this.pixelsToMeters(e*this.tileSize,t*this.tileSize,a)}},{key:"tileToLngLat",value:function(e,t,a){var i=this.tileToMeters(e,t,a),s=C()(i,2),l=s[0],d=s[1];return this.metersToLngLat(l,d)}},{key:"pixelsToTile",value:function(e,t){var a=Math.floor(Math.ceil(e/this.tileSize)-1),i=Math.floor(Math.ceil(t/this.tileSize)-1);return[a,i]}},{key:"pixelsToRaster",value:function(e,t,a){var i=this.tileSize<<a;return[e,i-t]}},{key:"tileBounds",value:function(e,t,a){var i=this.pixelsToMeters(e*this.tileSize,t*this.tileSize,a),s=C()(i,2),l=s[0],d=s[1],g=this.pixelsToMeters((e+1)*this.tileSize,(t+1)*this.tileSize,a),h=C()(g,2),p=h[0],L=h[1];return[l,d,p,L]}},{key:"tileLatLonBounds",value:function(e,t,a){var i=this.tileBounds(e,t,a),s=this.metersToLngLat(i[0],i[1]),l=C()(s,2),d=l[0],g=l[1],h=this.metersToLngLat(i[2],i[3]),p=C()(h,2),L=p[0],U=p[1];return[d,g,L,U]}},{key:"resolution",value:function(e){return this.initialResolution/Math.pow(2,e)}},{key:"lngLatToPixels",value:function(e,t,a){var i=this.lngLatToMeters(e,t),s=C()(i,2),l=s[0],d=s[1];return this.metersToPixels(l,d,a)}},{key:"pixelsTolngLat",value:function(e,t,a){var i=this.pixelsToMeters(e,t,a);return this.metersToLngLat(i[0],i[1])}},{key:"lngLatToTile",value:function(e,t,a){var i=this.lngLatToPixels(e,t,a),s=C()(i,2),l=s[0],d=s[1];return this.pixelsToTile(l,d)}},{key:"googleTile",value:function(e,t,a){return[e,Math.pow(2,a)-1-t]}},{key:"boundsToTileExtent",value:function(e,t,a,i,s){var l=this.lngLatToTile(e,i,s),d=C()(l,2),g=d[0],h=d[1],p=this.lngLatToTile(a,t,s),L=C()(p,2),U=L[0],W=L[1];return[[g,h],[U,W]]}},{key:"metersboundsToTileExtent",value:function(e,t,a,i,s){var l=this.metersToTile(e,i,s),d=C()(l,2),g=d[0],h=d[1],p=this.metersToTile(a,t,s),L=C()(p,2),U=L[0],W=L[1];return[[g,h],[U,W]]}}]),u}(),Q=null,re=function(n){var e=_slicedToArray(n,4),t=e[0],a=e[1],i=e[2],s=e[3];return{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[[[t,a],[t,s],[i,s],[i,a],[t,a]]]}}]}},q=function(n){return{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[n]}}]}},ue=function(){return{type:"FeatureCollection",features:[]}},Y=function(u){O()(e,u);var n=F()(e);function e(){var t;ae()(this,e);for(var a=arguments.length,i=new Array(a),s=0;s<a;s++)i[s]=arguments[s];return t=n.call.apply(n,[this].concat(i)),I()(x()(t),"imageOption",void 0),I()(x()(t),"imageBounds",void 0),I()(x()(t),"metersPerpixelsX",0),I()(x()(t),"metersPerpixelsY",0),I()(x()(t),"mapHelper",new X(256,"google")),t}return H()(e,[{key:"setGeoImage",value:function(){var t=j()(E()().mark(function i(s,l){var d,g,h;return E()().wrap(function(L){for(;;)switch(L.prev=L.next){case 0:y()(v()(e.prototype),"setImage",this).call(this,s),this.imageOption=l,d=l.extent,g=l.width,h=l.height,d&&(this.imageBounds=[].concat(o()(this.mapHelper.lngLatToMeters(d[0],d[1])),o()(this.mapHelper.lngLatToMeters(d[2],d[3]))),this.metersPerpixelsX=(this.imageBounds[2]-this.imageBounds[0])/g,this.metersPerpixelsY=(this.imageBounds[3]-this.imageBounds[1])/h);case 4:case"end":return L.stop()}},i,this)}));function a(i,s){return t.apply(this,arguments)}return a}()},{key:"exportGeoPolygon",value:function(){var t=j()(E()().mark(function i(s){var l=this,d,g,h,p,L,U=arguments;return E()().wrap(function(le){for(;;)switch(le.prev=le.next){case 0:return d=U.length>1&&U[1]!==void 0?U[1]:5,le.next=3,this.exportVector(s,d);case 3:return g=le.sent,h=this.imageBounds,p=g.map(function(Te){var Me=[Te.x*l.metersPerpixelsX+h[0],(l.imageOption.height-Te.y)*l.metersPerpixelsY+h[1]],_e=l.mapHelper.metersToLngLat(Me[0],Me[1]);return _e}),L=q(p),le.abrupt("return",L);case 8:case"end":return le.stop()}},i,this)}));function a(i){return t.apply(this,arguments)}return a}()},{key:"lngLat2ImagePixel",value:function(a){if(this.imageBounds){var i=this.mapHelper.lngLatToMeters(a[0],a[1]),s=C()(i,2),l=s[0],d=s[1],g=(l-this.imageBounds[0])/this.metersPerpixelsX,h=(d-this.imageBounds[1])/this.metersPerpixelsY;return h=this.imageOption.height-h,[g,h]}}}]),e}(k)},29972:function(){}}]);
